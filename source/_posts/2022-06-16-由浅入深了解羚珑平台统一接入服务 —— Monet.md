---
title: 由浅入深了解羚珑平台统一接入服务 —— Monet
subtitle: 由浅入深了解服务端羚珑平台统一 API 接入服务
cover: https://storage.360buyimg.com/neos-static-files/b1cd937c-2672-4ffd-9920-0add685ac74a.png
categories: 服务端开发
tags:
- 微服务
- 限流与熔断
author:
  nick: 阿清
  github_name: Janyd
date: 2022-06-16 10:46:00
---

# 由浅入深了解羚珑平台统一接入服务 —— Monet

## 一、项目背景

![](https://storage.360buyimg.com/neos-static-files/1aefd9ca-f6b4-4f58-b908-773e8f148e1f.png)
如图所示，现在有的架构按照业务平台拆分服务且都有自己的域名，需要独立对接单点登录系统完成登录，API 没有统一管理，部分 API 重复建设等等。

### 架构痛点

1. **重复建设**，每新增服务需要对接登录/新建域名映射

2. **API 管理**，缺少统一 API 管理，且部分功能重复建设接入

3. **权限**，权限各自为政，缺少统一权限管理

4. **监控限流**，缺少全局 API 监控与细粒度限流

基于以上痛点，羚珑平台需要业务网关与网关控制台来管理、限流、监控、权限校验与登录认证等，并且我们为该服务起了个代号：**Monet**。

### Monet 特性

清楚了解了现有架构痛点后，我们先给 Monet 预设基本功能：

* **统一管理**，API 由网关控制台进行统一管理，API 一次接入全部共享

* **统一鉴权**，登录认证流程由网关统一完成，让下游服务更加专注业务；权限集中由权限服务负责，网关结合权限服务完成统一权限校验

* **统一流控**，统一对 API 进行限流，且可根据不同纬度限流与熔断机制

* **统一监控**，接入公司提供监控平台，对各个 API 统一监控

---

## 二、技术选型

在技术选型之前，我们还需要对 Monet 几个方面需求分析：

* **定位**：Monet 与普通网关不一样，主要是作为业务 API 接入服务，Monet 还包含了部分业务逻辑

* **成本**：在技术选型中，需要考虑开发周期、团队技术栈以及下游服务接入改造成本

* **协议**：网关转发协议的支持，在不破坏原有服务 API 规范情况下，还需要考虑对其他协议转发；例如：HTTP、gRPC等等

* **扩展**：网关需要有扩展性，基于扩展填充登录认证、权限校验或其他业务

* **开源**：由于业务有商业化部署可能，优先考虑开源的方案

### 基础框架选择

由于后端采用 Java 的 Spring 生态开发的，所以在编程语言一致性上更加倾向 Java 语言开发的组件。所以在 Spring 生态中有两款网关可供选择，分别是：Spring Cloud Gateway[1] 与 Spring Cloud Zuul 2

Spring Cloud Gateway 由官方主推网关，Zuul 2 由 Netfix 公司开源的网关。两者在实际生产使用性能相比没有差距，Spring Cloud Gateway 基于 Spring 5.0、Spring Boot 2.0 与 Project Reactor，为服务提供一个简单有效的 API 网关；而 Zuul 1 基于同步 IO 与 Zuul 2 基于 Netty Server 异步 IO，都是 Spring Cloud 生态中的组件。以下两者一些区别：

| 网关   | Spring Cloud Gateway       | Spring Cloud Zuul 2 |
| ---- | -------------------------- | ------------------- |
| 易用性  | 简单易用                       | 参考资料较少              |
| 可维护性 | Spring 系列可扩展强，易配置可维护性好     | 可维护性差               |
| 成熟度  | Spring 社区成熟，但 Gateway 资源较少 | 开源不久，资料少            |

所以我们最终选择了 Spring Cloud Gateway 作为基础框架

### Spring Cloud Gateway

![](https://storage.360buyimg.com/neos-static-files/663ee8c6-8c0d-4df9-9921-cf204d48fae6.png)

 Spring Cloud Gateway 是基于 WebFlux 框架实现的，而 WebFlux 框架底层则使用了高性能的 Reactor 模式通信框架 Netty，具有拥有异步非阻塞、背压等特性。

异步非阻塞[2]：异步非阻塞提高网关吞吐量，但无法使缩短接口响应时间

背压[3]：背压可以自适应流量控制，避免网关全盘崩溃，所以单机压测 TPS 出现以下状况：

![](https://storage.360buyimg.com/neos-static-files/4d0ec037-de3c-4813-82e0-a51336bfa744.png)

Spring Cloud Gateway 的目标，不仅提供统一路由方式，并且基于 Filter 链的方式提供了网关基本的功能，例如：安全，监控/指标，和限流。

由于 Spring Cloud Gateway 是 Spring Cloud 生态系统中的网关，集成 Spring Cloud DiscoveryClient 便于服务发现与注册；

Spring Cloud Gateway 核心是 Route（路由）、Filter（过滤器）与 Predicate（断言）：

**Route**（路由）：网关配置的基本组成模块。一个 Route 模块由一个 ID，一个目标 URI，一组断言和一组过滤器定义。如果断言为真，则路由匹配，目标 URI 会被访问。

**Filter**（过滤器）：可以使用它进行拦截和修改请求，并且对上游的响应，进行二次处理。

**Prefidcate**（断言）：这是一个 Java 8 的 Predicate，可以使用它匹配来自 HTTP 请求的任何内容，例如 headers 或参数。

### 服务发现与注册中心

网关最重要功能是路由，一般网关路由为了能够将请求转发到目标服务，一般有是三种：

1. 直接将服务实例 IP，配置在网关上

2. 服务实例与网关中间有一层负载均衡服务，而将负载均衡服务内网域名或 IP 配置在网关上

3. 通过注册中心，将服务实例 IP 信息注册到注册中心上，网关可通过服务 ID  获取服务实例相应 IP

但是 1、2 点都有相应缺点，前者由于需要手工配置容易出错，且服务实例 IP 会有变动，后者负载均衡所使用成本较大，且也有运维成本；所以在这里我们使用第三种方式。

Spring Cloud Gateway 所支持注册中心比较多，从流行注册中心选出以下四种：

* Nacos

* Eureka

* Zookeeper

* Consul

为了避免有额外的运维成本，公司内部有独立提供 Zookeeper 服务，所以在此处使用 **Zookeeper**[4]

整体注册流程如下：

![](https://storage.360buyimg.com/neos-static-files/16177890-eef0-4896-a92c-1629b899ace3.png)

---

## 三、落地实现

Monet 完整架构如下：

![](https://storage.360buyimg.com/neos-static-files/edf2e264-62bd-4004-bb13-a4251c864351.png)

在此处主要扩展六种 Filter 分别是：AccessLog、API 监控、API 解析、限流熔断、登录认证、权限校验；

AccessLog：主要是打印请求日志，便于用于分析

API 解析：解析 URI 匹配 API，用于后面 Filter 权限校验、限流熔断等等

API 监控：接入公司监控平台，以 API 纬度上报监控信息

限流熔断：用于 API 限流熔断的过滤器

登录认证：判断登录态与完成登录流程

权限校验：通过 API 解析结果结合权限服务完成权限校验

### 登录流程

![](https://storage.360buyimg.com/neos-static-files/7094c4e5-43ba-4c3b-b1bd-01534c423655.png)

登录认证过滤器完成登录认证过程，下游服务无需过于关注是否已登录业务逻辑

### 动态路由

官方示例路由配置方式有两种：

* 配置文件

* 代码路由配置

![](https://storage.360buyimg.com/neos-static-files/c78fa0f0-f5d4-469e-8665-6d073873a26a.png)

![](https://storage.360buyimg.com/neos-static-files/c26c9b75-98d8-4ab7-b759-bfab7be65cbc.png)

以上两种方式，修改了之后都需要重启网关服务，在实际生产环境会产生影响

所以我们需要使用动态路由实现路由配置变更

![](https://storage.360buyimg.com/neos-static-files/352c828d-6a17-4f76-832b-434f19cdf81f.png)

路由配置存放至 Zookeeper，Monet 监听 Zookeeper 路由配置相应节点，网关控制台通过 Zookeeper API 变更网关路由配置，Monet 即可收到新路由配置信息，变更路由配置即可达到动态路由效果。

### API 解析与管理

![](https://storage.360buyimg.com/neos-static-files/b54e3605-091a-4b32-9529-64408e7e5f1c.png)

* API 管理
  
  统一 OpenAPI 3.0 作为服务 API 的定义格式，使用 OpenAPI Extension 维护权限、限流等信息

* API 路由解析
  
  利用前缀树[5] 作为 API 底层数据结构，便于 API 路由解析路由信息，为后续过滤器提供 API 信息

### 限流与熔断

Spring Cloud Gateway 可以根据流行的几种算法实现限流效果，所以直接找开源的限流熔断组件，流行的组件有：Hystrix 与 Sentinel[6]，两个组件区别：

| 功能      | Sentinel                     | Hystrix |
| ------- | ---------------------------- | ------- |
| 成熟度     | 社区活跃，文档较全                    | 已经停止维护  |
| 熔断降级策略  | 基于响应时间、异常比率、异常数              | 基于异常比率  |
| 实时统计实现  | 滑动窗口                         | 滑动窗口    |
| 动态规则配置  | 支持多种数据源                      | 支持多种数据源 |
| 扩展性     | 多个扩展点                        | 插件形式    |
| 限流      | 基于 QPS，支持基于调用关系的限流           | 优先支持    |
| 流量整形    | 支持预热模式、匀速器模式、预热排队模式（流量规则可配置） | 不支持     |
| 系统自适应保护 | 支持                           | 不支持     |

根据以上功能区别我们最终选择 Sentinel ，同时我们将流量规则配置也存储进 Zookeeper 中，通过网关控制台配置即可调整 API 限流与熔断规则。

## 四、总结

我们先通过介绍目前架构的痛点讲述项目背景，再通过技术选型选择网关的基础框架以及注册中心，基于基础框架落地实现 Monet 中的 API 解析、登录认证、权限校验、API 监控与限流熔断等。

## 参考链接

[1] Spring Cloud Gateway https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/

[2] How Java Is Used for Asynchronous Non-blocking Programming https://www.alibabacloud.com/blog/how-java-is-used-for-asynchronous-non-blocking-programming_597808

[3] Backpressure origins https://twitter.com/impurepics/status/1000466142866149377

[4] Spring Cloud Zookeeper https://docs.spring.io/spring-cloud-zookeeper/docs/current/reference/html/

[5]  Trie data structure https://en.wikipedia.org/wiki/Trie

[6] alibaba/Sentinel Wiki https://github.com/alibaba/Sentinel/wiki
